<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>气球发放状态</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }

        .filter-container {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-group label {
            display: inline-block;
            margin-right: 10px;
        }

        .form-group input,
        .form-group select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            margin-right: 10px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 10px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background-color: white;
            border-radius: 4px;
            cursor: pointer;
        }

        .pagination button:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }

        .pagination span {
            margin: 0 10px;
        }
        
        .table-container {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f8f9fa;
            font-weight: bold;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        .balloon-status {
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
        }

        .balloon-given {
            background-color: #28a745;
            color: white;
        }

        .balloon-not-given {
            background-color: #dc3545;
            color: white;
        }
    </style>
</head>
<body>
    <div class="filter-container">
        <div class="form-group">
            <label for="contestId">比赛ID：</label>
            <input type="text" id="contestId" value="104226">
        </div>
        <div class="form-group">
            <label for="statusTypeFilter">运行结果：</label>
            <input type="text" id="statusTypeFilter" value="5" disabled>
            <!-- <select id="statusTypeFilter" class="form-control" value = "5">
                <option value="">全部</option>
                <option value="5">运行正确</option>
                <option value="4">答案错误</option>
                <option value="3">运行错误</option>
                <option value="1">内存超限</option>
                <option value="0">正在判题</option>
                <option value="21">返回非零</option>
                <option value="20">代码太长</option>
                <option value="16">段错误</option>
                <option value="15">浮点错误</option>
                <option value="14">内部错误</option>
                <option value="13">格式错误</option>
                <option value="12">编译错误</option>
                <option value="10">输出超限</option>
                <option value="7">内存超限</option>
                <option value="6">运行超时</option>                
            </select> -->
        </div>
        <div class="form-group">
            <label for="refresh-interval">刷新间隔（秒）：</label>
            <input type="number" id="refresh-interval" value="60" min="1" max="600">
        </div>
        <select id="statusFilter">
            <option value="all">全部状态</option>
            <option value="given">已发放</option>
            <option value="not-given">未发放</option>
        </select>
    </div>
    <div class="table-container">
        <table id="balloonTable">
            <thead>
                <tr>
                    <th>用户ID</th>
                    <th>用户名</th>
                    <th>区域</th>
                    <th>座位</th>
                    <th>题目</th>
                    <th>气球颜色</th>
                    <th>提交时间</th>
                    <th>气球状态</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
        <div class="pagination">
            <button id="prevPage" onclick="changePage(-1)">上一页</button>
            <span id="pageInfo">第 1 页，共 1 页</span>
            <button id="nextPage" onclick="changePage(1)">下一页</button>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let pageSize = 10;
        let filteredData = [];
        let totalPages = 1;
        let globalSubmissions = [];
        let globalSeatMap = null;
        let globalBalloonStatusData = null;
        let balloonColors = {};

        async function fetchBalloonColors() {
            try {
                const response = await fetch('/api/balloon-colors');
                console.log('获取气球颜色配置响应:', response.json); // Add this line for debugging
                if (!response.ok) throw new Error('获取气球颜色配置失败');
                balloonColors = await response.json();
            } catch (error) {
                console.error('获取气球颜色配置失败:', error);
            }
        }

        document.getElementById('statusFilter').addEventListener('change', function() {
            currentPage = 1;
            renderTable(globalSubmissions, globalSeatMap, globalBalloonStatusData);
        });

        function changePage(delta) {
            const newPage = currentPage + delta;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderTable(globalSubmissions, globalSeatMap, globalBalloonStatusData);
            }
        }

        let refreshTimer;
        function updateRefreshInterval() {
            const seconds = document.getElementById('refresh-interval').value;
            const milliseconds = Math.max(1000, seconds * 1000);
            
            if (refreshTimer) {
                clearInterval(refreshTimer);
            }
            refreshTimer = setInterval(loadData, milliseconds);
        }

        async function fetchSubmissionData() {
            const contestId = document.getElementById('contestId').value;
            const statusTypeFilter = document.getElementById('statusTypeFilter').value;
            
            try {
                const response = await fetch(`/api/data?contestId=${contestId}&statusTypeFilter=${statusTypeFilter}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('获取数据失败:', error);
                return [];
            }
        }

        async function loadData() {
            try {
                const [submissionData, seatResponse, balloonStatusResponse] = await Promise.all([
                    fetchSubmissionData(),
                    fetch('/a.csv'),
                    fetch('/balloon/status')
                ]);

                const seatData = await seatResponse.text();
                const balloonStatusData = await balloonStatusResponse.json();

                const submissions = submissionData;
                // 按提交时间排序
                submissions.sort((a, b) => new Date(b.submitTime) - new Date(a.submitTime));
                const seats = parseCSV(seatData);

                const seatMap = new Map();
                seats.forEach(seat => {
                    if (seat.userId) {
                        seatMap.set(seat.userId, {
                            area: seat.area,
                            address: seat.address
                        });
                    }
                });

                globalSubmissions = submissions;
                globalSeatMap = seatMap;
                globalBalloonStatusData = balloonStatusData;
                renderTable(submissions, seatMap, balloonStatusData);
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const results = [];

            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const values = lines[i].split(',').map(v => v.trim());
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = values[index];
                });
                results.push(obj);
            }

            return results;
        }

        function renderTable(submissions, seatMap, balloonStatusData) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            // 根据状态筛选数据
            const statusFilter = document.getElementById('statusFilter').value;
            filteredData = submissions.filter(submission => {
                const statusKey = `${submission.userId}_${submission.problemId}`;
                const balloonStatus = balloonStatusData[statusKey] || { isGiven: false };
                if (statusFilter === 'given') return balloonStatus.isGiven;
                if (statusFilter === 'not-given') return !balloonStatus.isGiven;
                return true;
            });
        
            // 计算分页信息
            totalPages = Math.ceil(filteredData.length / pageSize);
            const start = (currentPage - 1) * pageSize;
            const end = Math.min(start + pageSize, filteredData.length);
            const pageData = filteredData.slice(start, end);
        
            // 更新分页控件
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages;
            document.getElementById('pageInfo').textContent = `第 ${currentPage} 页，共 ${totalPages} 页`;
        
            pageData.forEach(submission => {
                const seatInfo = seatMap.get(submission.userId) || { area: '未知', address: '未知' };
                const row = document.createElement('tr');
                
                const statusKey = `${submission.userId}_${submission.problemId}`;
                const balloonStatus = balloonStatusData[statusKey] || { isGiven: false };
                const buttonClass = balloonStatus.isGiven ? 'balloon-given' : 'balloon-not-given';
                const buttonText = balloonStatus.isGiven ? '已发放' : '未发放';
                
                row.innerHTML = `
                    <td>${submission.userId}</td>
                    <td>${submission.userName || '未知'}</td>
                    <td>${seatInfo.area}</td>
                    <td>${seatInfo.address}</td>
                    <td>${submission.problemId}</td>
                    <td>${generateBalloonColorDisplay(submission.problemId)}</td>
                    <td>${submission.submitTime}</td>
                    <td>
                        <button class="balloon-status ${buttonClass}" 
                                onclick="toggleBalloonStatus(this)" 
                                data-user-id="${submission.userId}"
                                data-problem-id="${submission.problemId}">
                            ${buttonText}
                        </button>
                    </td>
                `;
        
                tableBody.appendChild(row);
            });
        }

        function toggleBalloonStatus(button) {
            const isGiven = button.classList.contains('balloon-given');
            if (isGiven) {
                button.classList.remove('balloon-given');
                button.classList.add('balloon-not-given');
                button.textContent = '未发放';
            } else {
                button.classList.remove('balloon-not-given');
                button.classList.add('balloon-given');
                button.textContent = '已发放';
            }

            // 这里可以添加保存状态的逻辑
            const userId = button.dataset.userId;
            const problemId = button.dataset.problemId;
            saveBalloonStatus(userId, problemId, !isGiven);
        }

        async function saveBalloonStatus(userId, problemId, isGiven) {
            try {
                const response = await fetch('/balloon/status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userId,
                        problemId: problemId,
                        isGiven: isGiven
                    })
                });

                if (!response.ok) {
                    throw new Error('保存状态失败');
                }
                
                // 重新加载页面数据以更新显示
                await loadData();

                console.log(`保存状态成功: 用户${userId}的题目${problemId}气球状态: ${isGiven ? '已发放' : '未发放'}`);
            } catch (error) {
                console.error('保存状态失败:', error);
                alert('保存状态失败，请重试');
            }
        }

        // 页面加载完成后加载数据
        document.addEventListener('DOMContentLoaded', async () => {
            await fetchBalloonColors();
            loadData();
            // 绑定刷新间隔更新事件
            document.getElementById('refresh-interval').addEventListener('change', updateRefreshInterval);
            // 绑定筛选条件变化事件
            document.getElementById('contestId').addEventListener('change', loadData);
            document.getElementById('statusTypeFilter').addEventListener('change', loadData);
            // 初始化自动刷新
            updateRefreshInterval();
        });

        function generateBalloonColorDisplay(problemId) {
            // 获取气球颜色信息，如果不存在则使用默认值
            const defaultBalloonInfo = { hexColor: '#C8C8C8', balloonColor: '未知' };
            const balloonInfo = balloonColors[problemId] || defaultBalloonInfo;
            
            // 确保hexColor是有效的颜色值
            const hexColor = typeof balloonInfo.hexColor === 'string' && balloonInfo.hexColor.trim()
                ? balloonInfo.hexColor
                : defaultBalloonInfo.hexColor;
            
            // 确保气球颜色名称是有效的字符串
            const colorName = typeof balloonInfo.balloonColor === 'string' && balloonInfo.balloonColor.trim()
                ? balloonInfo.balloonColor
                : defaultBalloonInfo.balloonColor;
            
            return (
                '<div style="background-color: ' + hexColor + '; width: 20px; height: 20px; border-radius: 50%; display: inline-block; border: 1px solid #ddd;"></div> ' +
                colorName
            );
        }
    </script>
</body>
</html>